#!/usr/bin/env bash
level="$1" # INFO (stdout) or ERROR (stderr)
while read -r INPUT
do

	# there are potentially three timestamps: from filebeat reading the log, from the container processing the output and the output itself
	# internal message must implement following properties in this order: origin, @timestamp, source, level,
  # when implementing custom handler: if INPUT starts with '{ "origin": ' then the message is generated by the platform and should be in format alreayd

	timestamp=$( to-timestamp )
	if [[ "$INPUT" == '{ "origin": '*'}' ]] ; then

		printf '%s\n' "$INPUT"

	elif [[ "$level" == 'INFO' ]] ; then

		message=$( echo "$INPUT" | jq -aR . )
		printf '{ "origin": "%s", "@timestamp": "%s", "source": "nginx", "json":%s }\n' "$CONTECO_IMAGE" "$timestamp" "$message"

	else

		level=$(echo "$INPUT" | cut -d '[' -f2 | cut -d ']' -f1 )
		case $level in
			warn)
				level="WARNING"
			;;
		esac
		message=$(echo "$INPUT" | jq -aR .)
		printf '{ "origin": "%s", "@timestamp": "%s", "source": "logger", "level": "%s", "message":%s }\n' "$CONTECO_IMAGE" "$timestamp" "${level^^}" "$message"

	fi

done
